name: SSH Server with Ngrok

on:
  workflow_dispatch:  # Permite iniciar o workflow manualmente

jobs:
  setup-ssh-ngrok:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up SSH server
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # Gerar senha aleatória e armazená-la em uma variável
          SSH_PASSWORD=$(openssl rand -base64 12)
          
          # Criar usuário para SSH com a senha gerada
          sudo useradd -m -s /bin/bash sshuser
          echo "sshuser:$SSH_PASSWORD" | sudo chpasswd
          
          # Configurar o SSH para permitir login de senha
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          
          # Exibir credenciais de maneira segura
          echo "SSH user: sshuser"
          echo "SSH password: $SSH_PASSWORD"

      - name: Install Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install -y ngrok

      - name: Start Ngrok
        run: |
          # Configurar o token do Ngrok
          ngrok authtoken 1vgZrCA9yJDURy3OK1gNbS2G610_3CX2e2bqT4Ee88uMBk5he
          
          # Iniciar o túnel SSH
          nohup ngrok tcp 22 > ngrok.log 2>&1 &
          
          # Aguardar para que o túnel seja estabelecido
          sleep 10
          
          # Exibir a URL do túnel
          curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"[^"]*' | cut -d'"' -f4

      - name: Keep alive
        run: |
          # Manter o workflow em execução por um tempo muito longo
          while true; do
            echo "Keeping SSH server and Ngrok tunnel alive..."
            sleep 300  # Verificar a cada 5 minutos
            
            # Verificar se o Ngrok ainda está rodando
            if ! pgrep ngrok > /dev/null; then
              echo "Ngrok not running, restarting..."
              nohup ngrok tcp 22 > ngrok.log 2>&1 &
            fi
            
            # Verificar se o SSH ainda está rodando
            if ! systemctl is-active ssh > /dev/null; then
              echo "SSH server not running, restarting..."
              sudo systemctl restart ssh
            fi
          done
